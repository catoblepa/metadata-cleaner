#!/usr/bin/env python3

import gettext
import gi
import locale
import logging
import mimetypes
import os
import signal
import sys

gi.require_version("Gdk", "3.0")
gi.require_version("Gtk", "3.0")
gi.require_version("Handy", "1")

from gi.repository import GLib, Gio, Gtk, Handy  # noqa: E402


APP_ID = "@app_id@"
VERSION = "@version@"
LOCALE_DIR = "@localedir@"
PKGDATA_DIR = "@pkgdatadir@"
PYTHON_DIR = "@pythondir@"

sys.path.insert(1, PYTHON_DIR)


def setup_logging() -> None:
    logging.basicConfig()
    logging.getLogger().setLevel(logging.DEBUG)  # TODO: Handle logging level


def setup_i18n() -> None:
    try:
        locale.bindtextdomain(APP_ID, LOCALE_DIR)  # type: ignore
        locale.textdomain(APP_ID)  # type: ignore
    except AttributeError as e:
        print(f"Unable to set the gettext translation domain.\nError:\n{e}")
    gettext.bindtextdomain(APP_ID, LOCALE_DIR)
    gettext.textdomain(APP_ID)


def setup_resources() -> None:
    resource = Gio.Resource.load(
        os.path.join(PKGDATA_DIR, f"{APP_ID}.gresource")
    )
    Gio.Resource._register(resource)


def setup_mimetypes() -> None:
    # The Flatpak runtime doesn't have a mime.types file, we have to import
    # our own
    if os.path.exists("/.flatpak-info"):
        mimetypes.init(
            files=mimetypes.knownfiles +
            [os.path.join(PKGDATA_DIR, "mime.types")]
        )


def run_app() -> int:
    from metadatacleaner.app import MetadataCleaner
    app = MetadataCleaner(APP_ID, VERSION)
    signal.signal(signal.SIGINT, signal.SIG_DFL)
    exit_status = app.run()
    return exit_status


if __name__ == "__main__":
    setup_logging()
    setup_i18n()
    setup_resources()
    setup_mimetypes()

    Handy.init()

    exit_status = run_app()
    sys.exit(exit_status)
