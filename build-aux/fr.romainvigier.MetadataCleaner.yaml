# SPDX-FileCopyrightText: 2020, 2021 Romain Vigier <contact AT romainvigier.fr>
# SPDX-License-Identifier: GPL-3.0-or-later

app-id: fr.romainvigier.MetadataCleaner
default-branch: main
runtime: org.gnome.Platform
runtime-version: '40'
sdk: org.gnome.Sdk
command: metadata-cleaner
separate-locales: false
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.a'
  - '*.la'

modules:

  - name: ffmpeg
    buildsystem: autotools
    config-opts:
      - --disable-ffplay
      - --disable-ffprobe
      - --disable-doc
      - --disable-htmlpages
      - --disable-manpages
      - --disable-podpages
      - --disable-txtpages
      - --disable-decoders
      - --disable-encoders
      - --disable-parsers
      - --disable-bsfs
      - --disable-protocols
      - --enable-protocol=file
      - --disable-devices
      - --disable-filters
    cleanup:
      - /share/ffmpeg
    sources:
      - type: git
        url: https://git.ffmpeg.org/ffmpeg.git
        tag: n4.4
        commit: dc91b913b6260e85e1304c74ff7bb3c22a8c9fb1

  - name: perl
    buildsystem: simple
    build-commands:
      - ./Configure -des -Dprefix=$FLATPAK_DEST -Dman1dir=none -Dman3dir=none
      - make
      - make install
    post-install:
      # Fix wrong permissions
      - chmod -R u+w $FLATPAK_DEST/lib/perl5
    cleanup:
      - /bin/corelist
      - /bin/cpan
      - /bin/enc2xs
      - /bin/encguess
      - /bin/h2ph
      - /bin/h2xs
      - /bin/instmodsh
      - /bin/json_pp
      - /bin/libnetcfg
      - /bin/perl5*
      - /bin/perlbug
      - /bin/perldoc
      - /bin/perlivp
      - /bin/perlthanks
      - /bin/piconv
      - /bin/pl2pm
      - /bin/pod2html
      - /bin/pod2man
      - /bin/pod2text
      - /bin/pod2usage
      - /bin/podchecker
      - /bin/prove
      - /bin/ptar
      - /bin/ptardiff
      - /bin/ptargrep
      - /bin/shasum
      - /bin/splain
      - /bin/streamzip
      - /bin/xsubpp
      - /bin/zipdetails
      - '*.pod'
    sources:
      - type: git
        url: https://github.com/Perl/perl5.git
        tag: v5.34.0
        commit: 79a7b254d85a10b65126ad99bf10e70480569d68

  - name: exiftool
    buildsystem: simple
    build-commands:
      - perl Makefile.PL
      - make install
    cleanup:
      - '*.pod'
    sources:
      - type: git
        url: https://github.com/exiftool/exiftool.git
        tag: '12.28'
        commit: 11f9b77c6de851baea89fb24e56acadca64c0112

  - name: poppler
    buildsystem: cmake
    config-opts:
      - -DENABLE_BOOST=OFF
      - -DENABLE_SPLASH=OFF
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DBUILD_QT6_TESTS=OFF
      - -DBUILD_CPP_TESTS=OFF
      - -DBUILD_MANUAL_TESTS=OFF
      - -DENABLE_CPP=OFF
      - -DENABLE_UTILS=OFF
      - -DENABLE_QT5=OFF
      - -DENABLE_QT6=OFF
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/poppler/poppler.git
        tag: poppler-21.08.0
        commit: 4aaabeca58ebf0d398975b5569610651e451b542

  - name: python3-mutagen
    buildsystem: simple
    build-commands:
      - python3 setup.py build
      - python3 setup.py install --optimize=1 --single-version-externally-managed --prefix=$FLATPAK_DEST --root=/
    ensure-writable:
      - /lib/python3*/site-packages/easy-install.pth
    cleanup:
      - /bin/mid3cp
      - /bin/mid3iconv
      - /bin/mid3v2
      - /bin/moggsplit
      - /bin/mutagen-inspect
      - /bin/mutagen-pony
    sources:
      - type: git
        url: https://github.com/quodlibet/mutagen.git
        tag: release-1.45.1
        commit: 07108702b18d373d883ee9a36d2dd1066e621a0c

  - name: python3-libmat2
    buildsystem: simple
    build-commands:
      - python3 setup.py build
      - python3 setup.py install --optimize=1 --single-version-externally-managed --prefix=$FLATPAK_DEST --root=/
    ensure-writable:
      - /lib/python3*/site-packages/easy-install.pth
    sources:
      - type: git
        url: https://0xacab.org/jvoisin/mat2.git
        tag: 0.12.1
        commit: c5841a241dcf737599422e34a99d8001f974d13a

  - name: media-types
    buildsystem: simple
    build-commands:
      - install -D mime.types $FLATPAK_DEST/share/
    sources:
      - type: git
        url: https://salsa.debian.org/debian/media-types.git
        tag: 4.0.0
        commit: 0693ea7ac0d276c9c8dbae86e1b6c011443d7078

  - name: libadwaita
    buildsystem: meson
    config-opts:
      - -Dtests=false
      - -Dexamples=false
      - -Dgtk_doc=false
      - -Dvapi=false
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/libadwaita.git
        branch: main
    modules:
      - name: libsass
        buildsystem: meson
        sources:
          - type: git
            url: https://github.com/lazka/libsass.git
            branch: meson
        cleanup:
          - '*'
      - name: sassc
        buildsystem: meson
        sources:
          - type: git
            url: https://github.com/lazka/sassc.git
            branch: meson
        cleanup:
          - '*'

  - name: metadata-cleaner
    buildsystem: meson
    config-opts:
      - -Ddevel=true
    sources:
      - type: dir
        path: ../
